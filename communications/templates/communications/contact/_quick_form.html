<!-- Quick create form for anonymous users -->
<div class="mb-3">
    <div class="alert alert-info">
        <h6><i class="fas fa-magic"></i> Quick Start</h6>
        <p class="mb-0">
            We'll create your account and send your message in one step. 
            You'll receive a verification code to complete your account setup.
        </p>
    </div>
</div>

<form method="post" 
      action="{% url 'communications:contact_quick' %}"
      hx-post="{% url 'communications:contact_quick' %}"
      hx-target="#contact-form-container"
      hx-swap="outerHTML">
    
    {% csrf_token %}
    
    <div class="mb-3">
        <label for="{{ form.email.id_for_label }}" class="form-label">
            Email Address <span class="text-danger">*</span>
        </label>
        {{ form.email }}
        {% if form.email.errors %}
            <div class="invalid-feedback d-block">
                {% for error in form.email.errors %}{{ error }}{% endfor %}
            </div>
        {% endif %}
        <div class="form-text">
            We'll use this to create your account and contact you.
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6 mb-3">
            <label for="{{ form.first_name.id_for_label }}" class="form-label">
                First Name
            </label>
            {{ form.first_name }}
            {% if form.first_name.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.first_name.errors %}{{ error }}{% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div class="col-md-6 mb-3">
            <label for="{{ form.last_name.id_for_label }}" class="form-label">
                Last Name
            </label>
            {{ form.last_name }}
            {% if form.last_name.errors %}
                <div class="invalid-feedback d-block">
                    {% for error in form.last_name.errors %}{{ error }}{% endfor %}
                </div>
            {% endif %}
        </div>
    </div>
    
    <div class="mb-3">
        <label for="{{ form.subject.id_for_label }}" class="form-label">
            Subject <span class="text-danger">*</span>
        </label>
        {{ form.subject }}
        {% if form.subject.errors %}
            <div class="invalid-feedback d-block">
                {% for error in form.subject.errors %}{{ error }}{% endfor %}
            </div>
        {% endif %}
    </div>
    
    <div class="mb-3">
        <label for="{{ form.message.id_for_label }}" class="form-label">
            Message <span class="text-danger">*</span>
        </label>
        {{ form.message }}
        {% if form.message.errors %}
            <div class="invalid-feedback d-block">
                {% for error in form.message.errors %}{{ error }}{% endfor %}
            </div>
        {% endif %}
        <div class="form-text">
            Tell us how we can help you and your child.
        </div>
    </div>
    
    <div class="mb-3">
        <label for="id_captcha_1" class="form-label">CAPTCHA</label>
        <div class="d-flex align-items-center gap-2">
            {{ form.captcha }}
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="refreshCaptcha()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
        {% if form.captcha.errors %}
            <div class="text-danger small">{{ form.captcha.errors.0 }}</div>
        {% endif %}
        <div class="form-text">Please solve the math problem to verify you're human.</div>
    </div>
    
    {{ form.honeypot }}
    
    <div class="d-grid">
        <button type="submit" class="btn btn-success btn-lg" id="quick-submit-btn">
            <i class="fas fa-rocket"></i>
            <span class="btn-text">Create Account & Send Message</span>
            <span class="spinner-border spinner-border-sm htmx-indicator" role="status" aria-hidden="true" style="display: none;">
                <span class="visually-hidden">Creating account...</span>
            </span>
        </button>
    </div>
</form>

<style>
    .captcha input[type="text"] {
        width: 150px !important;
        display: inline-block !important;
    }
    .captcha img {
        margin-right: 10px;
    }
</style>

<div class="mt-3 text-center">
    <small class="text-muted">
        Already have an account? 
        <a href="{% url 'accounts:login' %}" class="text-decoration-none">
            Sign in here
        </a>
    </small>
</div>

<script>
function refreshCaptcha() {
    const captchaImg = document.querySelector('.captcha');
    if (captchaImg) {
        captchaImg.src = captchaImg.src.split('?')[0] + '?' + new Date().getTime();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form[hx-post]');
    const submitBtn = document.getElementById('quick-submit-btn');
    const btnText = submitBtn.querySelector('.btn-text');
    const spinner = submitBtn.querySelector('.htmx-indicator');
    
    if (form && submitBtn) {
        form.addEventListener('htmx:beforeRequest', function() {
            submitBtn.disabled = true;
            btnText.textContent = 'Creating account...';
            spinner.style.display = 'inline-block';
        });
        
        form.addEventListener('htmx:afterRequest', function() {
            submitBtn.disabled = false;
            btnText.textContent = 'Create Account & Send Message';
            spinner.style.display = 'none';
        });
    }
});
</script>
