{% extends 'admin_interface/base_admin.html' %}

{% block admin_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
        <i class="bi bi-shield-check me-2"></i>Impersonation Audit Logs
    </h2>
    <div class="text-muted">
        <i class="bi bi-info-circle me-1"></i>{{ page_obj.paginator.count }} total logs
    </div>
</div>

<!-- Search and Filters -->
<div class="admin-card p-4 mb-4">
    <form method="get" class="row g-3">
        <div class="col-md-6">
            <label for="search" class="form-label">Search Logs</label>
            <input type="text" class="form-control search-box" id="search" name="search" 
                   value="{{ search }}" placeholder="Search by admin, target, or reason...">
        </div>
        <div class="col-md-4">
            <label for="status" class="form-label">Filter by Status</label>
            <select class="form-select" id="status" name="status">
                <option value="">All Sessions</option>
                <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active Only</option>
                <option value="closed" {% if status_filter == 'closed' %}selected{% endif %}>Closed Only</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search me-1"></i>Search
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Logs Table -->
<div class="admin-card">
    <div class="card-header bg-transparent border-0">
        <h6 class="mb-0">
            <i class="bi bi-table me-2"></i>Audit Logs
        </h6>
    </div>
    <div class="card-body p-0">
        {% if page_obj %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Admin User</th>
                            <th>Target User</th>
                            <th>Started</th>
                            <th>Duration</th>
                            <th>Mode</th>
                            <th>Status</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in page_obj %}
                        <tr>
                            <td>
                                <div>
                                    <strong>{{ log.admin_user.get_full_name|default:log.admin_user.email }}</strong>
                                    <br>
                                    <small class="text-muted">{{ log.admin_user.email }}</small>
                                </div>
                            </td>
                            <td>
                                <div>
                                    <strong>{{ log.target_user.get_full_name|default:log.target_user.email }}</strong>
                                    <br>
                                    <small class="text-muted">{{ log.target_user.email }}</small>
                                </div>
                            </td>
                            <td>
                                <div>{{ log.started_at|date:"M j, Y" }}</div>
                                <small class="text-muted">{{ log.started_at|time:"g:i A" }}</small>
                            </td>
                            <td>
                                {% if log.ended_at %}
                                    <span class="badge bg-secondary">{{ log.duration }}</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-clock-history me-1"></i>Ongoing
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if log.readonly %}
                                    <span class="badge bg-info text-dark">
                                        <i class="bi bi-lock me-1"></i>Read-Only
                                    </span>
                                {% else %}
                                    <span class="badge bg-danger">
                                        <i class="bi bi-unlock me-1"></i>Full Access
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if log.is_active %}
                                    <span class="status-badge status-active">Active</span>
                                {% else %}
                                    <span class="status-badge status-inactive">Closed</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if log.reason_note %}
                                    <small class="text-muted">{{ log.reason_note|truncatewords:10 }}</small>
                                {% else %}
                                    <small class="text-muted fst-italic">No reason provided</small>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-shield-check fs-1 text-muted mb-3"></i>
                <h5 class="text-muted">No impersonation logs found</h5>
                <p class="text-muted">Audit logs will appear here when admins impersonate users</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<div class="d-flex justify-content-center mt-4">
    <nav aria-label="Log pagination">
        <ul class="pagination">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                        <i class="bi bi-chevron-double-left"></i>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                        <i class="bi bi-chevron-double-right"></i>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endif %}

<div class="alert alert-info mt-4">
    <i class="bi bi-info-circle me-2"></i>
    <strong>About Impersonation Logs:</strong> All impersonation events are automatically logged for security and auditing purposes. 
    Logs include admin user, target user, timestamps, access mode, IP address, and user agent. Logs cannot be deleted to maintain audit integrity.
</div>
{% endblock %}

