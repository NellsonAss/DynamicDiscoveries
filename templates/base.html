{% load static %}
{% load role_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Dynamic Discoveries - Where Curiosity Leads, Learning Follows{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.body.addEventListener('htmx:configRequest', function(evt) {
                evt.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
            });
        });
    </script>
    
    <link rel="icon" href="https://nastorage74blofkewhr6c.blob.core.windows.net/na-cdn-blob/favicon.ico" type="image/x-icon">
    
    {% block extra_head %}{% endblock %}
</head>
<body>
    <!-- Impersonation Banner (shown when admin is impersonating another user) -->
    {% include 'accounts/partials/_impersonation_banner.html' %}
    
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top" style="z-index: 1031;">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="{% url 'home' %}">
                <i class="bi bi-stars me-2"></i>Dynamic Discoveries
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'home' %}">Home</a>
                    </li>
                    
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'programs:program_catalog' %}">
                                <i class="bi bi-grid-3x3-gap me-1"></i>Program Catalog
                            </a>
                        </li>
                        <!-- Parent Navigation -->
                        {% show_role_menu 'Parent' as show_parent_menu %}
                        {% if show_parent_menu %}
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-people me-1"></i>Parent Tools
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="{% url 'programs:parent_dashboard' %}">
                                        <i class="bi bi-house me-2"></i>Parent Home
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'programs:manage_children' %}">
                                        <i class="bi bi-person-plus me-2"></i>Manage Children
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{% url 'programs:available_sessions_list' %}">
                                        <i class="bi bi-calendar-plus me-2"></i>Browse Sessions
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'programs:parent_bookings' %}">
                                        <i class="bi bi-list-check me-2"></i>My Bookings
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{% url 'programs:parent_dashboard' %}">
                                        <i class="bi bi-calendar-event me-2"></i>Available Programs
                                    </a></li>
                                </ul>
                            </li>
                        {% endif %}
                        
                        <!-- Contractor/Admin Navigation -->
                        {% should_show_contractor_menu as show_contractor_menu %}
                        {% if show_contractor_menu %}
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-tools me-1"></i>Contractor Tools
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="{% url 'programs:contractor_dashboard' %}">
                                        <i class="bi bi-speedometer2 me-2"></i>Dashboard
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{% url 'programs:contractor_availability_list' %}">
                                        <i class="bi bi-calendar-alt me-2"></i>My Availability
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'programs:contractor_sessions_list' %}">
                                        <i class="bi bi-chalkboard-teacher me-2"></i>My Sessions
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'programs:contractor_day_off_requests' %}">
                                        <i class="bi bi-calendar-x me-2"></i>Day Off Requests
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{% url 'programs:form_builder' %}">
                                        <i class="bi bi-clipboard-plus me-2"></i>Create Forms
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'people:contractor_onboarding' %}">
                                        <i class="bi bi-file-earmark-text me-2"></i>Onboarding (NDA & Wâ€‘9)
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'programs:contractor_dashboard' %}">
                                        <i class="bi bi-people me-2"></i>View Registrations
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{% url 'programs:buildout_list' %}">
                                        <i class="bi bi-diagram-3 me-2"></i>Program Buildouts
                                    </a></li>
                                </ul>
                            </li>
                        {% endif %}
                        
                        <!-- Admin Navigation -->
                        {% show_role_menu 'Admin' as show_admin_menu %}
                        {% if show_admin_menu %}
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-gear me-1"></i>Admin Tools
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="{% url 'admin_interface:dashboard' %}">
                                        <i class="bi bi-speedometer2 me-2"></i>Admin Dashboard
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{% url 'admin_interface:user_management' %}">
                                        <i class="bi bi-people me-2"></i>User Management
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'admin_interface:role_management' %}">
                                        <i class="bi bi-shield-check me-2"></i>Role Management
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'admin_interface:cost_management' %}">
                                        <i class="bi bi-currency-dollar me-2"></i>Cost Management
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{% url 'admin_interface:program_instance_management' %}">
                                        <i class="bi bi-calendar-event me-2"></i>Program Instances
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'admin_interface:registration_management' %}">
                                        <i class="bi bi-clipboard-check me-2"></i>Registrations
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{% url 'admin_interface:contact_management' %}">
                                        <i class="bi bi-envelope me-2"></i>Contact Inquiries
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'admin_interface:impersonation_logs' %}">
                                        <i class="bi bi-shield-check me-2"></i>Impersonation Logs
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{% url 'admin:index' %}">
                                        <i class="bi bi-gear me-2"></i>Django Admin (Legacy)
                                    </a></li>
                                </ul>
                            </li>
                        {% endif %}
                        
                        <!-- Consultant Navigation -->
                        {% show_role_menu 'Consultant' as show_consultant_menu %}
                        {% if show_consultant_menu %}
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'communications:contact_list' %}">
                                    <i class="bi bi-envelope me-1"></i>Contact Inquiries
                                </a>
                            </li>
                        {% endif %}
                    {% else %}
                        <!-- Public Navigation -->
                        {% if request.resolver_match.url_name == 'home' %}
                            <li class="nav-item">
                                <a class="nav-link" href="#programs">Programs</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#tutoring">Tutoring & Assessments</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'communications:contact_entry' %}">Contact</a>
                            </li>
                        {% endif %}
                    {% endif %}
                </ul>
                <ul class="navbar-nav">
                    {% if user.is_authenticated %}
                        <!-- Role Switcher (for multi-role users) -->
                        <li class="nav-item d-flex align-items-center me-2">
                            {% include 'accounts/partials/_role_switcher.html' %}
                        </li>
                        
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="bi bi-person-circle me-1"></i>{{ user.email }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><h6 class="dropdown-header">
                                    <i class="bi bi-person-badge me-2"></i>{{ user.get_role_names|join:", " }}
                                </h6></li>
                                <li><hr class="dropdown-divider"></li>
                                
                                <!-- Quick Access based on role -->
                                {% show_role_menu 'Parent' as show_parent_quick_menu %}
                                {% if show_parent_quick_menu %}
                                    <li><a class="dropdown-item" href="{% url 'programs:parent_dashboard' %}">
                                        <i class="bi bi-house me-2"></i>Parent Dashboard
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'programs:available_sessions_list' %}">
                                        <i class="bi bi-calendar-plus me-2"></i>Browse Sessions
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'programs:parent_bookings' %}">
                                        <i class="bi bi-list-check me-2"></i>My Bookings
                                    </a></li>
                                {% endif %}
                                
                                {% show_role_menu 'Contractor' as show_contractor_quick_menu %}
                                {% if show_contractor_quick_menu %}
                                    <li><a class="dropdown-item" href="{% url 'programs:contractor_dashboard' %}">
                                        <i class="bi bi-speedometer2 me-2"></i>Contractor Dashboard
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'programs:contractor_availability_list' %}">
                                        <i class="bi bi-calendar-alt me-2"></i>My Availability
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'programs:contractor_sessions_list' %}">
                                        <i class="bi bi-chalkboard-teacher me-2"></i>My Sessions
                                    </a></li>
                                {% endif %}
                                
                                {% show_role_menu 'Admin' as show_admin_quick_menu %}
                                {% if show_admin_quick_menu %}
                                    <li><a class="dropdown-item" href="{% url 'accounts:user_list' %}">
                                        <i class="bi bi-people me-2"></i>User Management
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'admin_interface:role_management' %}">
                                        <i class="bi bi-shield-check me-2"></i>Role Management
                                    </a></li>
                                    <li><a class="dropdown-item" href="{% url 'admin_interface:cost_management' %}">
                                        <i class="bi bi-currency-dollar me-2"></i>Cost Management
                                    </a></li>
                                {% endif %}
                                
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{% url 'accounts:profile' %}">
                                    <i class="bi bi-person me-2"></i>Profile
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'auth:account_logout' %}">
                                    <i class="bi bi-box-arrow-right me-2"></i>Logout
                                </a></li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'accounts:login' %}">Login</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link btn btn-primary text-white px-3 ms-2" href="{% url 'communications:contact_entry' %}">Contact Us</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <main>
        <style>
            .onboarding-banner { z-index: 1030; position: sticky; top: 56px; }
            @media (min-width: 992px) { .onboarding-banner { top: 64px; } }
        </style>
        {% if messages %}
            <div class="container py-4">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <div class="container py-4">
            {% include 'includes/breadcrumbs.html' %}
            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    {% block extra_js %}{% endblock %}
</body>
</html> 